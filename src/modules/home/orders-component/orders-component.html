<section class="order-page m-2">
  <div class="d-flex justify-content-between align-items-center page-header">
    <h2 class="page-title">Gerenciamento de Ordens de Serviço</h2>
    <button mat-flat-button color="primary" (click)="openOrderDialog(orderDialog)">
      <mat-icon>add_task</mat-icon>
      Nova Ordem de Serviço
    </button>
  </div>

  <!-- CARD DE FILTROS -->
  <mat-card class="search-card mat-elevation-z2 mb-3 p-3">
    <div class="row align-items-center">
      <!-- Filtro por Nome do Cliente -->
      <div class="col-md-3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Cliente</mat-label>
          <input matInput placeholder="Nome do cliente" [(ngModel)]="filters.clienteFiltro">
          <mat-icon matSuffix>person_search</mat-icon>
        </mat-form-field>
      </div>

      <!-- Filtro por Status -->
      <div class="col-md-3">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="filters.statusFiltro">
            <mat-option value="">Todos</mat-option>
            <mat-option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.viewValue }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Filtro por Data (Range) -->
      <div class="col-md-4">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Período de Criação</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate placeholder="Início" [(ngModel)]="filters.dataInicio">
            <input matEndDate placeholder="Fim" [(ngModel)]="filters.dataFim">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </div>

      <!-- Botões de Ação dos Filtros -->
      <div class="col-md-2 d-flex justify-content-end gap-2">
        <button mat-stroked-button color="warn" (click)="clearSearch()" matTooltip="Limpar Filtros">
          <mat-icon>filter_alt_off</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="applySearch()" matTooltip="Filtrar">
          <mat-icon>search</mat-icon>
        </button>
      </div>
    </div>
  </mat-card>

  <!-- CARD DA TABELA -->
  <mat-card class="orders-card mat-elevation-z2">
    <mat-card-content>
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort class="full-width-table">
          <!-- Coluna Cliente -->
          <ng-container matColumnDef="clientName">
            <th mat-header-cell *matHeaderCellDef>Cliente</th>
            <td mat-cell *matCellDef="let order">
              {{getClientName(order.cliente)}}
            </td>
          </ng-container>

          <ng-container matColumnDef="device">
            <th mat-header-cell *matHeaderCellDef>Dispositivo</th>
            <td mat-cell *matCellDef="let order">{{ order.device }}</td>
          </ng-container>

          <!-- Coluna Data Abertura -->
          <ng-container matColumnDef="openDate">
            <th mat-header-cell *matHeaderCellDef>Data Abertura</th>
            <td mat-cell *matCellDef="let order">{{ order.openDate | date:'dd/MM/yyyy HH:mm' }}</td>
          </ng-container>

          <!-- Coluna Data Fechamento -->
          <ng-container matColumnDef="closeDate">
            <th mat-header-cell *matHeaderCellDef>Data Fechamento</th>
            <td mat-cell *matCellDef="let order">{{ order.closeDate | date:'dd/MM/yyyy HH:mm' }}</td>
          </ng-container>

          <!-- Coluna Valor Total -->
          <ng-container matColumnDef="totalValue">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let order">{{ order.total | currency:'BRL' }}</td>
          </ng-container>

          <!-- Coluna Status -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let order">
              <span class="status-badge">
                {{ order.status }}
              </span>
            </td>
          </ng-container>

          <!-- Ações -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="text-center">Ações</th>
            <td mat-cell *matCellDef="let order" class="text-center">
              <button mat-icon-button color="primary" (click)="openOrderDialog(orderDialog, order)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteOrder(order)">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <tr mat-row *matNoDataRow>
            <td class="mat-cell text-center py-4" colspan="5">
              Nenhuma ordem encontrada com os filtros selecionados.
            </td>
          </tr>
        </table>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="loading" class="loading-shade">
        <mat-spinner diameter="50"></mat-spinner>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <mat-paginator [length]="totalOrders" [pageSize]="pageSize" [pageSizeOptions]="[5, 10, 25]"
                     (page)="changePage($event)" showFirstLastButtons>
      </mat-paginator>
    </mat-card-actions>
  </mat-card>

  <!-- DIALOGO (MODAL) DE CRIAÇÃO/EDIÇÃO -->
  <ng-template #orderDialog let-data="data">
    <h2 mat-dialog-title>
      <mat-icon class="dialog-icon">receipt_long</mat-icon>
      {{ data?.uuid ? 'Editar Ordem de Serviço' : 'Nova Ordem de Serviço' }}
    </h2>

    <mat-dialog-content>
      <form [formGroup]="orderForm" class="order-form row">

        <!-- Linha 1: UUID e Cliente -->
        <mat-card>
          <p>
            UUID: <span>{{data?.uuid}}</span>
          </p>
        </mat-card>

        <!-- NOVO CAMPO: Seletor de Cliente (Seleção Única) -->
        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Cliente</mat-label>
            <!-- REMOVIDO: o atributo 'multiple' -->
            <mat-select formControlName="clienteUuid" required>
              <mat-option *ngFor="let client of availableClients" [value]="client.uuid">
                {{ client.name }} ({{ client.email }})
              </mat-option>
            </mat-select>
            <mat-hint>Selecione o cliente responsável pela Ordem.</mat-hint>
            <mat-error *ngIf="orderForm.get('clienteUuid')?.hasError('required')">
              Obrigatório
            </mat-error>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Dispositivo</mat-label>
            <input matInput formControlName="device" placeholder="Ex: Notebook Dell" required>
          </mat-form-field>
        </div>

        <!-- Linha 2: Serviços (UUIDs) -->
        <div class="col-12">
          <div class="d-flex gap-2 align-items-center mb-2">
            <mat-form-field appearance="outline" class="flex-grow-1">
              <mat-label>Serviços</mat-label>
              <mat-select [(ngModel)]="serviceToAddUuid" [ngModelOptions]="{standalone: true}" placeholder="Selecione um serviço">
                <mat-option *ngFor="let service of availableServices" [value]="service.uuid">
                  {{ service.service }} ({{ service.value | currency:'BRL' }})
                </mat-option>
              </mat-select>
            </mat-form-field>

            <button mat-flat-button color="primary" (click)="addSelectedService()" [disabled]="!serviceToAddUuid">
              <mat-icon>add</mat-icon>
              Adicionar
            </button>
          </div>

          <!-- Lista de serviços adicionados -->
          <div *ngIf="selectedServices.length > 0" class="mb-3">
            <div *ngFor="let svc of selectedServices" class="d-flex justify-content-between align-items-center p-2 mb-1 service-item">
              <div>
                <strong>{{ svc.service }}</strong>
                <div class="muted small">{{ svc.uuid }}</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <div>{{ svc.value | currency:'BRL' }}</div>
                <button mat-icon-button color="warn" (click)="removeSelectedService(svc.uuid)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <mat-hint *ngIf="selectedServices.length === 0">Selecione um serviço no dropdown e clique em Adicionar. Ao editar, os serviços da ordem serão carregados aqui.</mat-hint>
          <mat-error *ngIf="orderForm.get('serviceUUIDs')?.hasError('required')">
            Obrigatório
          </mat-error>
        </div>

        <!-- Linha 3: Descrição -->
        <div class="col-12">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Descrição do Problema</mat-label>
            <textarea matInput formControlName="description" rows="3" required></textarea>
          </mat-form-field>
        </div>

        <!-- Linha 4: Status e Valores -->
        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Status</mat-label>
            <mat-select formControlName="status" required>
              <mat-option *ngFor="let option of statusOptions" [value]="option.value">
                {{ option.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Extras (R$)</mat-label>
            <input matInput type="number" formControlName="extras" min="0" required>
          </mat-form-field>
        </div>

        <div class="col-md-4">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Desconto (R$)</mat-label>
            <input matInput type="number" formControlName="discount" min="0" required>
          </mat-form-field>
        </div>

        <mat-card>
          <p>
            Total (R$): <span>{{calculatedTotal}}</span>
          </p>
        </mat-card>
      </form>
    </mat-dialog-content>

    <mat-dialog-actions align="end">
      <button mat-button mat-dialog-close>Cancelar</button>
      <button mat-flat-button color="primary" (click)="saveOrder()" [disabled]="orderForm.invalid">
        <mat-icon>save</mat-icon>
        Salvar Ordem
      </button>
    </mat-dialog-actions>
  </ng-template>
</section>
